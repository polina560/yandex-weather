!function($){const pluginName="yiiDynamicForm",regexID=/^(.+?)(-[\d-]+)(.+)$/i,regexName=/(^.+?)([\[\d{1,}\]]+)(\[.+]$)/i;$.fn.yiiDynamicForm=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?($.error(`Method ${e} does not exist on jQuery.yiiDynamicForm`),!1):methods.init.apply(this,arguments)};const events={beforeInsert:"beforeInsert",afterInsert:"afterInsert",beforeDelete:"beforeDelete",afterDelete:"afterDelete",limitReached:"limitReached"},methods={init:function(e){return this.each(function(){e.template=_parseTemplate(e)})},addItem:function(e,t,i){_addItem(e,t,i)},deleteItem:function(e,t,i){_deleteItem(e,t,i)},updateContainer:function(){const widgetOptions=eval($(this).attr("data-dynamicform"));_updateAttributes(widgetOptions),_restoreSpecialJs(widgetOptions),_fixFormValidaton(widgetOptions)}},_parseTemplate=function(e){const t=$(e.template);t.find("input, textarea, select").each(function(){const e=$(this);if(e.is(":checkbox")||e.is(":radio")){const i=e.is(":checkbox")?"checkbox":"radio",n=e.attr("name"),o=t.find(`input[type="hidden"][name="${n}"]`).first(),a=t.find(`input[type="${i}"][name="${n}"]`).length;o&&1===a&&(e.val(1),o.val(0)),e.prop("checked",!1)}else e.is("select")?e.find("option:selected").removeAttr("selected"):e.val("")});const i=$(`#${e.formId}`).yiiActiveForm("data");let n="has-error",o="has-success";return void 0!==i&&(n=i.settings.errorCssClass,o=i.settings.successCssClass),t.find("."+n).removeClass(n),t.find("."+o).removeClass(o),t},_getWidgetOptionsRoot=function(widgetOptions){return eval($(widgetOptions.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform"))},_getLevel=function(e){let t=e.parents("div[data-dynamicform]").length;return t=t<0?0:t},_count=function(e,t){return e.closest(`.${t.widgetContainer}`).find(t.widgetItem).length},_createIdentifiers=function(e){return new Array(e+2).join("0").split("")},_addItem=function(e,t,i){const n=_count(i,e),o=`.${e.widgetContainer}`;if(n<e.limit){const t=$(e.template).clone(!1,!1);"top"===e.insertPosition?i.closest(o).find(e.widgetBody).prepend(t):i.closest(o).find(e.widgetBody).append(t),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),i.closest(o).triggerHandler(events.afterInsert,t)}else i.closest(o).triggerHandler(events.limitReached,e.limit)},_removeValidations=function($elem,widgetOptions,count){if(count>1){$elem.find("div[data-dynamicform]").each(function(){const $item=$(this),currentWidgetOptions=eval($item.attr("data-dynamicform")),level=_getLevel($item),identifiers=_createIdentifiers(level),numItems=$item.find(currentWidgetOptions.widgetItem).length,form=$(`#${currentWidgetOptions.formId}`);for(let e=1;e<=numItems-1;e++){let t=identifiers;t[level]=e,currentWidgetOptions.fields.forEach(function(e){const i=e.id.replace("{}",t.join("-"));"undefined"!==form.yiiActiveForm("find",i)&&form.yiiActiveForm("remove",i)})}});const level=_getLevel($elem.closest(`.${widgetOptions.widgetContainer}`)),widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions);let identifiers=_createIdentifiers(level);identifiers[0]=$(widgetOptionsRoot.widgetItem).length-1,identifiers[level]=count-1;const form=$(`#${widgetOptions.formId}`);widgetOptions.fields.forEach(function(e){const t=e.id.replace("{}",identifiers.join("-"));"undefined"!==form.yiiActiveForm("find",t)&&form.yiiActiveForm("remove",t)})}},_deleteItem=function(e,t,i){const n=_count(i,e);if(n>e.min){const t=i.closest(e.widgetItem),o=$(`.${e.widgetContainer}`);!1!==o.triggerHandler(events.beforeDelete,t)&&(_removeValidations(t,e,n),t.remove(),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),o.triggerHandler(events.afterDelete))}},_updateAttrID=function($elem,index){const widgetOptions=eval($elem.closest("div[data-dynamicform]").attr("data-dynamicform")),id=$elem.attr("id");let newID=id;if(void 0!==id){const matches=id.match(regexID);if(matches&&4===matches.length){matches[2]=matches[2].substring(1,matches[2].length-1);let identifiers=matches[2].split("-");if(identifiers[0]=index,identifiers.length>1){let widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))}),widgetsOptions=widgetsOptions.reverse();for(let e=identifiers.length-1;e>=1;e--)identifiers[e]=$elem.closest(widgetsOptions[e].widgetItem).index()}newID=`${matches[1]}-${identifiers.join("-")}-${matches[3]}`,$elem.attr("id",newID)}else newID=id+index,$elem.attr("id",newID)}return id!==newID&&($elem.closest(widgetOptions.widgetItem).find(`.field-${id}`).each(function(){$(this).removeClass(`field-${id}`).addClass(`field-${newID}`)}),$elem.closest(widgetOptions.widgetItem).find(`label[for='${id}']`).attr("for",newID)),newID},_updateAttrName=function($elem,index){let name=$elem.attr("name");if(void 0!==name){const matches=name.match(regexName);if(matches&&4===matches.length){matches[2]=matches[2].replace(/\]\[/g,"-").replace(/]|\[/g,"");let identifiers=matches[2].split("-");if(identifiers[0]=index,identifiers.length>1){let widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))}),widgetsOptions=widgetsOptions.reverse();for(let e=identifiers.length-1;e>=1;e--)identifiers[e]=$elem.closest(widgetsOptions[e].widgetItem).index()}name=`${matches[1]}[${identifiers.join("][")}]${matches[3]}`,$elem.attr("name",name)}}return name},_updateCKFinderFileInput=function(e){if(!e.hasClass("file-input")&&!e.hasClass("input-group"))return;let t=e.find("input").attr("id"),i=!!t&&t.match(/[-\d]+/);if(!i)return;let n=i[0].split("-").length-1,o=2,a="-\\d+-";for(;o<n;)a+="\\d+-",o++;a=new RegExp(a),e.find("button.file-input").each(function(){$(this).attr("onclick",$(this).attr("onclick").replace(a,i))})},_updateAttributes=function(e){const t=_getWidgetOptionsRoot(e);$(t.widgetItem).each(function(e){$(this).find("*").each(function(){const t=$(this);_updateAttrID(t,e),_updateAttrName(t,e)})}),$(t.widgetItem).each(function(e){$(this).find("*").each(function(){_updateCKFinderFileInput($(this))})})},_fixFormValidatonInput=function(e,t,i,n){if(void 0!==t){(t=$.extend(!0,{},t)).id=i,t.container=`.field-${i}`,t.input=`#${i}`,t.name=n,t.value=$(`#${i}`).val(),t.status=0;const o=$(`#${e.formId}`);"undefined"!==o.yiiActiveForm("find",i)&&o.yiiActiveForm("remove",i),o.yiiActiveForm("add",t)}},_fixFormValidaton=function(widgetOptions){const widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions);$(widgetOptionsRoot.widgetBody).find("input, textarea, select").each(function(){const $item=$(this),id=$item.attr("id"),name=$item.attr("name");if(void 0!==id&&void 0!==name){const currentWidgetOptions=eval($item.closest("div[data-dynamicform]").attr("data-dynamicform")),matches=id.match(regexID);if(matches&&4===matches.length){matches[2]=matches[2].substring(1,matches[2].length-1);const e=_getLevel($item),t=_createIdentifiers(e-1),i=`${matches[1]}-${t.join("-")}-${matches[3]}`,n=$(`#${currentWidgetOptions.formId}`).yiiActiveForm("find",i);_fixFormValidatonInput(currentWidgetOptions,n,id,name)}}})},_restoreKrajeeDepdrop=function($elem){const configDepdrop=$.extend(!0,{},eval($elem.attr("data-krajee-depdrop"))),inputID=$elem.attr("id"),matchID=inputID.match(regexID);if(matchID&&4===matchID.length)for(let e=0;e<configDepdrop.depends.length;++e){const t=configDepdrop.depends[e].match(regexID);t&&4===t.length&&(configDepdrop.depends[e]=t[1]+matchID[2]+t[3])}$elem.depdrop(configDepdrop)},_restoreSpecialJs=function(widgetOptions){const widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions),$hasInputmask=$(widgetOptionsRoot.widgetItem).find("[data-plugin-inputmask]");$hasInputmask.length>0&&$hasInputmask.each(function(){const $item=$(this);$item.inputmask("remove"),$item.inputmask(eval($item.attr("data-plugin-inputmask")))});const $hasDatepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-datepicker]");$hasDatepicker.length>0&&$hasDatepicker.each(function(){const $item=$(this);$item.parent().removeData().datepicker("remove"),$item.parent().datepicker(eval($item.attr("data-krajee-datepicker")))});const $hasTimepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-timepicker]");$hasTimepicker.length>0&&$hasTimepicker.each(function(){const $item=$(this);$item.removeData().off(),$item.parent().find(".bootstrap-timepicker-widget").remove(),$item.unbind(),$item.timepicker(eval($item.attr("data-krajee-timepicker")))});const $hasMaskmoney=$(widgetOptionsRoot.widgetItem).find("[data-krajee-maskMoney]");$hasMaskmoney.length>0&&$hasMaskmoney.each(function(){const $item=$(this);$item.parent().find("input").removeData().off();const id=`#${$item.attr("id")}`,input=$(id),display=$(`${id}-disp`);display.maskMoney("destroy"),display.maskMoney(eval($item.attr("data-krajee-maskMoney"))),display.maskMoney("mask",parseFloat(input.val())),display.on("change",function(){const e=display.maskMoney("unmasked")[0];input.val(e),input.trigger("change")})});const $hasFileinput=$(widgetOptionsRoot.widgetItem).find("[data-krajee-fileinput]");$hasFileinput.length>0&&$hasFileinput.each(function(){const $item=$(this);$item.fileinput(eval($item.attr("data-krajee-fileinput")))});const $hasTouchSpin=$(widgetOptionsRoot.widgetItem).find("[data-krajee-TouchSpin]");$hasTouchSpin.length>0&&$hasTouchSpin.each(function(){const $item=$(this);$item.TouchSpin("destroy"),$item.TouchSpin(eval($item.attr("data-krajee-TouchSpin")))});const $hasSpectrum=$(widgetOptionsRoot.widgetItem).find("[data-krajee-spectrum]");$hasSpectrum.length>0&&$hasSpectrum.each(function(){const $item=$(this),id=`#${$item.attr("id")}`,sourceID=`${id}-source`;$(sourceID).spectrum("destroy"),$(sourceID).unbind(),$(id).unbind();const configSpectrum=eval($item.attr("data-krajee-spectrum"));configSpectrum.change=function(e){jQuery(id).val(e.toString())},$(sourceID).attr("name",$(sourceID).attr("id")),$(sourceID).spectrum(configSpectrum),$(sourceID).spectrum("set",jQuery(id).val()),$(id).on("change",function(){$(sourceID).spectrum("set",jQuery(id).val())})});const $hasDepdrop=$(widgetOptionsRoot.widgetItem).find("[data-krajee-depdrop]");$hasDepdrop.length>0&&$hasDepdrop.each(function(){const e=$(this);void 0===e.data("select2")&&(e.removeData().off(),e.unbind(),_restoreKrajeeDepdrop(e))});const $hasSelect2=$(widgetOptionsRoot.widgetItem).find("[data-krajee-select2]");$hasSelect2.length>0&&$hasSelect2.each(function(){const $item=$(this),id=$item.attr("id"),configSelect2=eval($item.attr("data-krajee-select2"));$item.data("select2")&&$item.select2("destroy");let configDepdrop=$item.data("depdrop");configDepdrop&&(configDepdrop=$.extend(!0,{},configDepdrop),$item.removeData().off(),$item.unbind(),_restoreKrajeeDepdrop($item));const s2LoadingFunc="undefined"!=typeof initSelect2Loading?initSelect2Loading:initS2Loading,s2OpenFunc="undefined"!=typeof initSelect2DropStyle?initSelect2Loading:initS2Loading;$.when($item.select2(configSelect2)).done(s2LoadingFunc(id,".select2-container--krajee"));const kvClose="kv_close_"+id.replace(/-/g,"_");$item.on("select2:opening",function(e){s2OpenFunc(id,kvClose,e)}),$item.on("select2:unselect",function(){window[kvClose]=!0}),configDepdrop&&initDepdropS2(id,configDepdrop.loadingText?configDepdrop.loadingText:"Loading ...")});const $hasAceEditor=$(widgetOptionsRoot.widgetItem).find(".ace_editor");if($hasAceEditor.length>0){const e=ace.edit($hasAceEditor.first()[0]),t=ace.edit($hasAceEditor.last()[0]);t.setTheme(e.getTheme()),t.getSession().setMode(e.getSession().getMode()),t.setReadOnly(e.getReadOnly());const i=$hasAceEditor.last().find("textarea");t.getSession().setValue(i.val()),t.getSession().on("change",function(){i.val(t.getSession().getValue())})}const $hasCKEditor=$(widgetOptionsRoot.widgetItem).find("[data-ckeditor-type]");$hasCKEditor.length>0&&$hasCKEditor.each(function(){const e=$(this);let t=e.attr("data-ckeditor-type");const i=JSON.parse(e.attr("data-ckeditor-options"));void 0!==t&&t||(t={}),window[`${t}Editor`].create(this,i).catch(e=>{console.error(e)}),this.removeAttribute("data-ckeditor-type"),this.removeAttribute("data-ckeditor-options")})}}(window.jQuery);